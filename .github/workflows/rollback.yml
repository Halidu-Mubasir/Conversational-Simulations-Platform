# Auto-generated by AutoRollback Tool
# Generated on: 2025-11-07T10:54:33.425632Z

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      failed_run_id:
        description: 'ID of the failed deployment run'
        required: false
        type: string
  repository_dispatch:
    types: [rollback-trigger]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Rollback Event
        run: |
          echo "ðŸ”„ ROLLBACK INITIATED"
          echo "Reason: ${{ github.event.inputs.reason || github.event.client_payload.reason }}"
          echo "Failed Run ID: ${{ github.event.inputs.failed_run_id || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback App Service Deployment
        run: |
          echo "ðŸ”„ Rolling back App Service: product-portal-o4qkrj"
          echo "Using slot swap for instant rollback (< 1 second)"

          # Swap production back to staging (instant rollback)
          az webapp deployment slot swap \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name product-portal-o4qkrj \
            --slot production \
            --target-slot staging

          echo "âœ… Rollback completed successfully!"
          echo "Production has been restored to the previous version"
          echo "The failed deployment is now in the staging slot"

      
      - name: Verify Rollback Success
        run: |
          echo "â³ Waiting 20 seconds for rollback to complete..."
          sleep 20
          
          echo "ðŸ” Verifying application health after rollback..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/healthz || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Rollback successful! Application is healthy."
            exit 0
          else
            echo "âŒ Rollback verification failed (HTTP $HTTP_STATUS)"
            echo "âš ï¸  Manual intervention required!"
            exit 1
          fi
      
      - name: Send Notification
        if: always()
        run: |
          echo "ðŸ“§ Sending rollback notification to: halidumubashir@gmail.com"
          # In production, integrate with email service or Slack
