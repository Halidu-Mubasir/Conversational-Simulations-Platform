# Auto-generated by AutoRollback Tool
# Generated on: 2025-11-20T10:08:24.594659Z

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      failed_run_id:
        description: 'ID of the failed deployment run'
        required: false
        type: string
  repository_dispatch:
    types: [rollback-trigger]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Rollback Event
        run: |
          echo "ðŸ”„ ROLLBACK INITIATED"
          echo "Reason: ${{ github.event.inputs.reason || github.event.client_payload.reason }}"
          echo "Failed Run ID: ${{ github.event.inputs.failed_run_id || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback App Service Deployment
        run: |
          echo "ðŸ”„ Rolling back App Service: conversational-simulation-ai-app-o3uj78"
          echo "Using slot swap for instant rollback (< 1 second)"

          # Use Azure Management API to perform slot swap (rollback)
          AZURE_TOKEN="${{ secrets.AZURE_ACCESS_TOKEN }}"
          SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"

          # Mask token in logs
          echo "::add-mask::$AZURE_TOKEN"

          # Azure Management API endpoint for slot swap
          SWAP_URL="https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Web/sites/conversational-simulation-ai-app-o3uj78/slots/staging/slotsswap?api-version=2023-01-01"

          echo "ðŸ“ Rollback swap API: Azure Management API"
          echo "â³ Initiating rollback slot swap..."

          # Swap staging and production (this rolls back to previous version in staging)
          SWAP_STATUS=$(curl -X POST \
            -H "Authorization: Bearer $AZURE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"targetSlot": "production"}' \
            -s -o /tmp/rollback_swap.txt \
            -w "%{http_code}" \
            "$SWAP_URL")

          echo "Swap HTTP Status: $SWAP_STATUS"

          if [ "$SWAP_STATUS" -eq 200 ] || [ "$SWAP_STATUS" -eq 202 ]; then
            echo "âœ… Rollback slot swap initiated!"
            echo "â³ Waiting 15 seconds for swap to complete..."
            sleep 15
            echo "âœ… Rollback completed successfully!"
            echo "ðŸŽ‰ Production has been restored to the previous version"
            echo "ðŸ“¦ The failed deployment is now in the staging slot"
          else
            echo "âŒ Rollback swap failed with status: $SWAP_STATUS"
            echo "Response:"
            cat /tmp/rollback_swap.txt || echo "(No response)"
            echo ""
            echo "âš ï¸  MANUAL ROLLBACK REQUIRED:"
            echo "Please manually swap slots in Azure Portal:"
            echo "Azure Portal: https://portal.azure.com â†’ conversational-simulation-ai-app-o3uj78 â†’ Deployment slots â†’ Swap"
            exit 1
          fi

      
      - name: Verify Rollback Success
        run: |
          echo "â³ Waiting 20 seconds for rollback to complete..."
          sleep 20
          
          echo "ðŸ” Verifying application health after rollback..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/ || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Rollback successful! Application is healthy."
            exit 0
          else
            echo "âŒ Rollback verification failed (HTTP $HTTP_STATUS)"
            echo "âš ï¸  Manual intervention required!"
            exit 1
          fi
      
      - name: Send Notification
        if: always()
        run: |
          echo "ðŸ“§ Sending rollback notification to: team@example.com"
          # In production, integrate with email service or Slack
