# Auto-generated by AutoRollback Tool
# Generated on: 2025-11-20T07:21:09.394888Z

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      failed_run_id:
        description: 'ID of the failed deployment run'
        required: false
        type: string
  repository_dispatch:
    types: [rollback-trigger]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Rollback Event
        run: |
          echo "üîÑ ROLLBACK INITIATED"
          echo "Reason: ${{ github.event.inputs.reason || github.event.client_payload.reason }}"
          echo "Failed Run ID: ${{ github.event.inputs.failed_run_id || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback App Service Deployment
        run: |
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è  ROLLBACK NOT AVAILABLE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo ""
          echo "App Service: conversational-simulation-ai-app-j0w1tq"
          echo "Reason: Deployment slots are not supported on Free/Basic tiers"
          echo ""
          echo "Deployment slots require Standard (S1+) or Premium (P1V2+) tier"
          echo "Current tier does not support blue/green deployment or instant rollback"
          echo ""
          echo "Manual intervention required:"
          echo "1. Check application logs in Azure Portal"
          echo "2. Identify the issue and fix the code"
          echo "3. Push a new deployment with the fix"
          echo ""
          echo "To enable automatic rollback in the future:"
          echo "- Upgrade to Standard S1 or higher tier"
          echo "- This will enable deployment slots for zero-downtime deployments and instant rollback"

          exit 1

      
      - name: Verify Rollback Success
        run: |
          echo "‚è≥ Waiting 20 seconds for rollback to complete..."
          sleep 20
          
          echo "üîç Verifying application health after rollback..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/ || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Rollback successful! Application is healthy."
            exit 0
          else
            echo "‚ùå Rollback verification failed (HTTP $HTTP_STATUS)"
            echo "‚ö†Ô∏è  Manual intervention required!"
            exit 1
          fi
      
      - name: Send Notification
        if: always()
        run: |
          echo "üìß Sending rollback notification to: team@example.com"
          # In production, integrate with email service or Slack
