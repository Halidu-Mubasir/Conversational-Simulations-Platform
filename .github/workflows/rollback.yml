# Auto-generated by AutoRollback Tool for AKS
# Generated on: 2026-01-21T12:02:54.117918Z

name: Rollback AKS Deployment

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Revision to rollback to (leave empty for previous)'
        required: false
        default: ''

env:
  AKS_CLUSTER_NAME: test-cluster
  RESOURCE_GROUP: AlphaRG
  K8S_NAMESPACE: default
  DEPLOYMENT_NAME: test-aks-app

jobs:
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Set up kubectl with kubeconfig
        run: |
          echo "ðŸŽ¯ Setting up kubectl with kubeconfig..."
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl config current-context
          echo "âœ… Connected to cluster: $AKS_CLUSTER_NAME"

      - name: Check deployment history
        run: |
          echo "ðŸ“œ Deployment history:"
          kubectl rollout history deployment/$DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE

      - name: Get current deployment status
        run: |
          echo "ðŸ“Š Current deployment status:"
          kubectl get deployment $DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE
          kubectl get pods --namespace=$K8S_NAMESPACE -l app=test-aks-app

      - name: Perform rollback
        run: |
          echo "âª Rolling back deployment..."
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            echo "Rolling back to revision: ${{ github.event.inputs.revision }}"
            kubectl rollout undo deployment/$DEPLOYMENT_NAME --to-revision=${{ github.event.inputs.revision }} --namespace=$K8S_NAMESPACE
          else
            echo "Rolling back to previous revision"
            kubectl rollout undo deployment/$DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE
          fi

      - name: Wait for rollback to complete
        run: |
          echo "â³ Waiting for rollback to complete..."
          kubectl rollout status deployment/$DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE --timeout=5m
          echo "âœ… Rollback completed successfully"

      - name: Verify rollback
        run: |
          echo "ðŸ” Verifying rollback..."
          kubectl get deployment $DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE
          kubectl get pods --namespace=$K8S_NAMESPACE -l app=test-aks-app
          echo "âœ… Rollback verification complete"

      - name: Get current image
        run: |
          echo "ðŸ–¼ï¸  Current deployment image:"
          kubectl get deployment $DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE -o jsonpath='{{.spec.template.spec.containers[0].image}}'
          echo ""

      - name: Health check
        run: |
          echo "ðŸ¥ Running post-rollback health check..."
          sleep 10
          SERVICE_IP=$(kubectl get service test-aks-app --namespace=$K8S_NAMESPACE -o jsonpath='{{.status.loadBalancer.ingress[0].ip}}')
          if [ -n "$SERVICE_IP" ]; then
            curl -f http://$SERVICE_IP/health && echo "âœ… Health check passed" || echo "âš ï¸  Health check failed"
          else
            echo "âš ï¸  LoadBalancer IP not available"
          fi

      - name: Rollback Summary
        if: always()
        run: |
          echo "ðŸ“Š Rollback Summary"
          echo "===================="
          echo "Cluster: $AKS_CLUSTER_NAME"
          echo "Namespace: $K8S_NAMESPACE"
          echo "Deployment: $DEPLOYMENT_NAME"
          echo "Status: $(kubectl rollout status deployment/$DEPLOYMENT_NAME --namespace=$K8S_NAMESPACE 2>&1 || echo 'Check manually')"
