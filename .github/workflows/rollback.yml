# Auto-generated by AutoRollback Tool
# Generated on: 2025-11-13T08:20:17.114850Z

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      failed_run_id:
        description: 'ID of the failed deployment run'
        required: false
        type: string
  repository_dispatch:
    types: [rollback-trigger]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Rollback Event
        run: |
          echo "ðŸ”„ ROLLBACK INITIATED"
          echo "Reason: ${{ github.event.inputs.reason || github.event.client_payload.reason }}"
          echo "Failed Run ID: ${{ github.event.inputs.failed_run_id || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback App Service Deployment
        run: |
          echo "ðŸ”„ Rolling back App Service: conversation-simulation-ai-yeseyl"
          echo "Using slot swap for instant rollback (< 1 second)"

          # Extract credentials from publish profile for API authentication
          PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
          USERNAME=$(echo "$PUBLISH_PROFILE" | sed -n 's/.*userName="\([^"]*\)".*/\1/p' | head -1)
          PASSWORD=$(echo "$PUBLISH_PROFILE" | sed -n 's/.*userPWD="\([^"]*\)".*/\1/p' | head -1)

          # Mask password in logs
          echo "::add-mask::$PASSWORD"

          # Use Kudu API to swap slots back (rollback)
          # This swaps production and staging slots
          SWAP_URL="https://conversation-simulation-ai-yeseyl.scm.azurewebsites.net/api/slotsswap/staging"

          echo "ðŸ“ Rollback swap API: $SWAP_URL"
          echo "â³ Initiating rollback slot swap..."

          SWAP_STATUS=$(curl -X POST \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/json" \
            -s -o /tmp/rollback_swap.txt \
            -w "%{http_code}" \
            "$SWAP_URL")

          echo "Swap HTTP Status: $SWAP_STATUS"

          if [ "$SWAP_STATUS" -eq 200 ] || [ "$SWAP_STATUS" -eq 202 ]; then
            echo "âœ… Rollback slot swap initiated!"
            echo "â³ Waiting 10 seconds for swap to complete..."
            sleep 10
            echo "âœ… Rollback completed successfully!"
            echo "Production has been restored to the previous version"
            echo "The failed deployment is now in the staging slot"
          else
            echo "âŒ Rollback swap failed with status: $SWAP_STATUS"
            echo "Response:"
            cat /tmp/rollback_swap.txt || echo "(No response)"
            exit 1
          fi

      
      - name: Verify Rollback Success
        run: |
          echo "â³ Waiting 20 seconds for rollback to complete..."
          sleep 20
          
          echo "ðŸ” Verifying application health after rollback..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/healthz || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Rollback successful! Application is healthy."
            exit 0
          else
            echo "âŒ Rollback verification failed (HTTP $HTTP_STATUS)"
            echo "âš ï¸  Manual intervention required!"
            exit 1
          fi
      
      - name: Send Notification
        if: always()
        run: |
          echo "ðŸ“§ Sending rollback notification to: halidumubashir@gmail.com"
          # In production, integrate with email service or Slack
