# Auto-generated by AutoRollback Tool for AKS
# Generated on: 2026-01-20T07:38:50.205539Z

name: Deploy to AKS

on:
  # NOTE: push trigger is disabled for initial setup
  # After first successful deployment, uncomment to enable auto-deploy on push
  # push:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'Dev'

env:
  ACR_LOGIN_SERVER: 
  ACR_NAME: 
  AKS_CLUSTER_NAME: test-cluster
  RESOURCE_GROUP: AlphaRG
  IMAGE_NAME: test-aks-app
  K8S_NAMESPACE: default

jobs:
  build-and-deploy:
    name: Build Docker Image and Deploy to AKS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          echo "üîê Logging into ACR: $ACR_LOGIN_SERVER"
          az acr login --name $ACR_NAME

      - name: Build and tag Docker image
        run: |
          echo "üê≥ Building Docker image..."
          IMAGE_TAG=${{ github.sha }}
          docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG -f ./Dockerfile .
          docker tag $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
          echo "‚úÖ Image built: $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push image to ACR
        run: |
          echo "üì§ Pushing image to ACR..."
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
          echo "‚úÖ Image pushed successfully"

      - name: Set AKS context
        run: |
          echo "üéØ Connecting to AKS cluster: $AKS_CLUSTER_NAME"
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER_NAME --overwrite-existing
          kubectl config current-context

      - name: Deploy Kubernetes manifests
        run: |
          echo "üì¶ Deploying to AKS..."
          kubectl apply -f k8s/deployment.yml --namespace=$K8S_NAMESPACE
          echo "‚úÖ Manifests applied"

      - name: Update deployment image
        run: |
          echo "üîÑ Updating deployment with new image..."
          kubectl set image deployment/test-aks-app test-aks-app=$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }} --namespace=$K8S_NAMESPACE
          echo "‚úÖ Image updated"

      - name: Wait for rollout to complete
        run: |
          echo "‚è≥ Waiting for deployment rollout..."
          kubectl rollout status deployment/test-aks-app --namespace=$K8S_NAMESPACE --timeout=5m
          echo "‚úÖ Deployment completed successfully"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          kubectl get pods --namespace=$K8S_NAMESPACE -l app=test-aks-app
          kubectl get service test-aks-app --namespace=$K8S_NAMESPACE

      - name: Get Service URL
        run: |
          echo "üåê Getting service endpoint..."
          kubectl get service test-aks-app --namespace=$K8S_NAMESPACE -o jsonpath='{{.status.loadBalancer.ingress[0].ip}}'
          echo ""
          echo "‚ÑπÔ∏è  Note: LoadBalancer IP may take a few minutes to be assigned"

      - name: Health check (optional)
        continue-on-error: true
        run: |
          echo "üè• Running health check..."
          # Wait for LoadBalancer IP
          sleep 30
          SERVICE_IP=$(kubectl get service test-aks-app --namespace=$K8S_NAMESPACE -o jsonpath='{{.status.loadBalancer.ingress[0].ip}}')
          if [ -n "$SERVICE_IP" ]; then
            curl -f http://$SERVICE_IP/health || echo "‚ö†Ô∏è  Health check endpoint not ready yet"
          else
            echo "‚ö†Ô∏è  LoadBalancer IP not assigned yet"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Image: $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}"
          echo "Cluster: $AKS_CLUSTER_NAME"
          echo "Namespace: $K8S_NAMESPACE"
          echo "Deployment: test-aks-app"
